---
import Welcome from '../components/Welcome.astro';
import Layout from '../layouts/Layout.astro';

import { supabase } from "../lib/supabase";

const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return Astro.redirect("/signin");
}

let session;
try {
  session = await supabase.auth.setSession({
    refresh_token: refreshToken.value,
    access_token: accessToken.value,
  });
  if (session.error) {
    Astro.cookies.delete("sb-access-token", {
      path: "/",
    });
    Astro.cookies.delete("sb-refresh-token", {
      path: "/",
    });
    return Astro.redirect("/signin");
  }
} catch (error) {
  Astro.cookies.delete("sb-access-token", {
    path: "/",
  });
  Astro.cookies.delete("sb-refresh-token", {
    path: "/",
  });
  return Astro.redirect("/signin");
}
---

<Layout>
  <div class="min-h-screen bg-neutral-950 text-white p-4">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-2xl font-bold mb-6">Welcome to Souperb!</h1>
      <div class="bg-neutral-900 rounded-lg p-4 mb-4">
        <p class="mb-4">You are logged in successfully!</p>
        <a
          href="/chat"
          class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md"
        >
          Go to Chat
        </a>
      </div>
    </div>
  </div>
</Layout>